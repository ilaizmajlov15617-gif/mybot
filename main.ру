import telebot
from telebot import types
import random

TOKEN = '8352938832:AAGooh41WdnQgmcqNxBzYSnC1QvqMpeCqBg'
CHANNEL_ID = '@swag40444' 
ADMIN_ID = 875740812

bot = telebot.TeleBot(TOKEN)

data_storage = {
    "üé§ –†–ï–ü–ï–†–´": {"–ü–ª–∞—Ç–∏–Ω–∞": "–†–æ–±–µ—Ä—Ç", "OG Buda": "–ì—Ä–∏–≥–æ—Ä–∏–π", "Mayot": "–ê—Ä—Ç–µ–º"},
    "üöó –ú–ê–®–ò–ù–´": {"BMW": "–ê–≥—Ä–µ—Å—Å–∏—è", "Mercedes": "–ö–æ–º—Ñ–æ—Ä—Ç", "Tesla": "–≠–ª–µ–∫—Ç—Ä–∏—á–∫–∞"},
    "üéÆ –ò–ì–†–´": {"Minecraft": "–ö—É–±—ã", "CS:GO": "–°—Ç—Ä–µ–ª—å–±–∞", "Dota 2": "–ú–∏–¥"},
    "ü•ò –ï–î–ê": {"–®–∞—É—Ä–º–∞": "–õ–∞–≤–∞—à", "–ü–∏—Ü—Ü–∞": "–°—ã—Ä", "–ë–æ—Ä—â": "–°—É–ø"}
}

game_data = {}

def check_subscribe(user_id):
    try:
        status = bot.get_chat_member(CHANNEL_ID, user_id).status
        return status in ['member', 'administrator', 'creator']
    except: return False

@bot.message_handler(commands=['start'])
def start(message):
    if check_subscribe(message.from_user.id):
        markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
        markup.add("3", "4", "5", "6")
        bot.send_message(message.chat.id, "–°–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫ –∏–≥—Ä–∞–µ—Ç?", reply_markup=markup)
    else:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è", url="https://t.me/swag40444"))
        markup.add(types.InlineKeyboardButton("–Ø –ø–æ–¥–ø–∏—Å–∞–ª—Å—è ‚úÖ", callback_data="check_sub"))
        bot.send_message(message.chat.id, "–ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã –∏–≥—Ä–∞—Ç—å!", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "check_sub")
def sub_check(call):
    if check_subscribe(call.from_user.id):
        bot.delete_message(call.message.chat.id, call.message.message_id)
        start(call.message)
    else:
        bot.answer_callback_query(call.id, "–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–ø–∏—à–∏—Å—å!", show_alert=True)

@bot.message_handler(func=lambda m: m.text in ["3", "4", "5", "6"])
def select_category(message):
    game_data[message.chat.id] = {"count": int(message.text), "current": 1}
    markup = types.InlineKeyboardMarkup()
    for cat in data_storage.keys():
        markup.add(types.InlineKeyboardButton(cat, callback_data=f"cat_{cat}"))
    bot.send_message(message.chat.id, "–í—ã–±–µ—Ä–∏ —Ç–µ–º–∞—Ç–∏–∫—É:", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data.startswith("cat_"))
def start_game(call):
    category_name = call.data.replace("cat_", "")
    chat_id = call.message.chat.id
    word = random.choice(list(data_storage[category_name].keys()))
    desc = data_storage[category_name][word]
    game_data[chat_id].update({
        "mafia_index": random.randint(1, game_data[chat_id]["count"]),
        "word": word, "desc": desc, "category": category_name
    })
    bot.delete_message(chat_id, call.message.message_id)
    send_turn(chat_id)

def send_turn(chat_id):
    data = game_data[chat_id]
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("üëÄ –£–ó–ù–ê–¢–¨ –†–û–õ–¨", callback_data="reveal_role"))
    bot.send_message(chat_id, f"üé≤ –ò–≥—Ä–æ–∫ ‚Ññ{data['current']}, —Ç–≤–æ–π —Ö–æ–¥!", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "reveal_role")
def reveal(call):
    chat_id = call.message.chat.id
    data = game_data[chat_id]
    if data["current"] == data["mafia_index"]:
        text = "üï∂ –¢–´ –ú–ê–§–ò–Ø!\n\n–ù–µ —Å–ø–∞–ª—å—Å—è!"
    else:
        text = f"üé§ –¢–´ –ú–ò–†–ù–´–ô!\n\n–¢–µ–º–∞: {data['category']}\n–û–±—ä–µ–∫—Ç: {data['word']}\n–ò–Ω—Ñ–æ: {data['desc']}"
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("‚ùå –°–ö–†–´–¢–¨", callback_data="next_player"))
    bot.edit_message_text(text, chat_id, call.message.message_id, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "next_player")
def next_p(call):
    chat_id = call.message.chat.id
    bot.delete_message(chat_id, call.message.message_id)
    if game_data[chat_id]["current"] < game_data[chat_id]["count"]:
        game_data[chat_id]["current"] += 1
        send_turn(chat_id)
    else:
        bot.send_message(chat_id, "üî• –í—Å–µ —Ä–æ–ª–∏ —Ä–æ–∑–¥–∞–Ω—ã! –û–±—Å—É–∂–¥–∞–π—Ç–µ!")
        del game_data[chat_id]

bot.infinity_polling()
