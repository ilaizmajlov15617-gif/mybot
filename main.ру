import telebot
from telebot import types
import random

# --- НАСТРОЙКИ ---
TOKEN = '8352938832:AAGooh41WdnQgmcqNxBzYSnC1QvqMpeCqBg'
CHANNEL_ID = '@swag40444' 

bot = telebot.TeleBot(TOKEN)

# --- БАЗА ДАННЫХ С ФОТО ---
data_storage = {
    "РЕПЕРЫ": {
        "Бунтовский": {"desc": "Исполнитель", "img": "https://i.ytimg.com/vi/b_KqFf_X5m8/maxresdefault.jpg"},
        "Платина": {"desc": "Роберт Плаудис", "img": "https://images.skylines.gdn/v1/artists/5772/media/ca42d689-53e7-48f0-be2d-f9e403d64c01.jpg"},
        "OG Buda": {"desc": "Григорий Ляхов", "img": "https://images.skylines.gdn/v1/artists/5730/media/121516e4-4d1a-42c2-b94d-4566a5039e10.jpg"},
        "Mayot": {"desc": "Артем Никитин", "img": "https://rhymemag.com/wp-content/uploads/2020/09/mayot-shlyapa.jpg"},
        "Toxi$": {"desc": "Андрей Смелянский", "img": "https://avatars.mds.yandex.net/get-altay/10636361/2a0000018b105d1e6709848f0761502f6430/orig"},
        "Big Baby Tape": {"desc": "Егор Ракитин", "img": "https://avatars.mds.yandex.net/get-kinopoisk-image/6201401/e04505f0-6c9e-4e4c-8367-3474f7626372/orig"}
    },
    "МАШИНЫ": {
        "BMW M5": {"desc": "Немецкий седан", "img": "https://avatars.mds.yandex.net/get-verba/1030388/2a000001815f9b40742d93e18001712a8637/orig"},
        "Mercedes G63": {"desc": "Внедорожник", "img": "https://avatars.mds.yandex.net/get-verba/216201/2a00000178457c617b76e10986518a4a2d59/orig"},
        "Lada Priora": {"desc": "Отечественный авто", "img": "https://s.auto.drom.ru/i24213/pubs/4/47957/2493390.jpg"},
        "Tesla Model S": {"desc": "Электрокар", "img": "https://motor.ru/imgs/2021/01/28/09/4474718/e79f60f6448a349c2889e496b1b26871a2a472c6.jpg"}
    },
    "ИГРЫ": {
        "Minecraft": {"desc": "Песочница", "img": "https://upload.wikimedia.org/wikipedia/ru/3/3f/Minecraft_block.png"},
        "CS 2": {"desc": "Шутер", "img": "https://escorenews.com/storage/2023/03/22/8da16e87f8.jpg"},
        "Dota 2": {"desc": "MOBA", "img": "https://cdn.akamai.steamstatic.com/apps/dota2/images/dota2_social.jpg"},
        "Brawl Stars": {"desc": "Мобильная игра", "img": "https://m.media-amazon.com/images/M/MV5BMGY3N2ViYjAtN2VlYS00ZTk0LWFhN2QtMmJlOTI4NjgxNGE0XkEyXkFqcGdeQXVyMTI0MzA4MzE5._V1_.jpg"}
    },
    "ЕДА": {
        "Шаурма": {"desc": "Мясо в лаваше", "img": "https://povar.ru/uploads/3a/81/2a/39/domashnyaya_shaurma_s_kuricei-542157.JPG"},
        "Пицца": {"desc": "Тесто с сыром", "img": "https://cdn.papajohns.ru/images/catalog/thumbs/full/Pepperoni-traditional.jpg"},
        "Борщ": {"desc": "Суп", "img": "https://img.delo-vcusa.ru/2017/05/Klassicheskiy-borshh.jpg"}
    }
}

game_data = {}

def check_subscribe(user_id):
    try:
        status = bot.get_chat_member(CHANNEL_ID, user_id).status
        return status in ['member', 'administrator', 'creator']
    except: return False

def main_menu(chat_id):
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Режим Шпион", callback_data="mode_spy"))
    markup.add(types.InlineKeyboardButton("Режим Рандомайзер", callback_data="mode_rand"))
    bot.send_message(chat_id, "Выберите режим игры или функцию:", reply_markup=markup)

@bot.message_handler(commands=['start'])
def start(message):
    if check_subscribe(message.from_user.id):
        main_menu(message.chat.id)
    else:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Подписаться", url="https://t.me/swag40444"))
        markup.add(types.InlineKeyboardButton("Я подписался", callback_data="check_sub"))
        bot.send_message(message.chat.id, "Для использования бота подпишитесь на канал.", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "check_sub")
def sub_check(call):
    if check_subscribe(call.from_user.id):
        try: bot.delete_message(call.message.chat.id, call.message.message_id)
        except: pass
        main_menu(call.message.chat.id)
    else:
        bot.answer_callback_query(call.id, "Подписка не найдена", show_alert=True)

@bot.callback_query_handler(func=lambda call: call.data == "to_main")
def back_to_main(call):
    try: bot.delete_message(call.message.chat.id, call.message.message_id)
    except: pass
    main_menu(call.message.chat.id)

# --- РАНДОМАЙЗЕР ---
@bot.callback_query_handler(func=lambda call: call.data == "mode_rand")
def rand_start(call):
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("В меню", callback_data="to_main"))
    bot.edit_message_text("Введите диапазон через пробел (например: 1 100):", call.message.chat.id, call.message.message_id, reply_markup=markup)
    bot.register_next_step_handler(call.message, process_random)

def process_random(message):
    try:
        nums = [int(i) for i in message.text.split()]
        res = random.randint(min(nums), max(nums))
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Еще раз", callback_data="mode_rand"))
        markup.add(types.InlineKeyboardButton("В меню", callback_data="to_main"))
        bot.send_message(message.chat.id, f"Результат: {res}", reply_markup=markup)
    except:
        bot.send_message(message.chat.id, "Ошибка. Введите два числа через пробел.")
        main_menu(message.chat.id)

# --- ШПИОН ---
@bot.callback_query_handler(func=lambda call: call.data == "mode_spy")
def spy_start(call):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("3", "4", "5", "6", "В меню")
    bot.send_message(call.message.chat.id, "Сколько человек играет?", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text in ["3", "4", "5", "6"])
def select_category(message):
    game_data[message.chat.id] = {"count": int(message.text), "current": 1}
    show_categories(message.chat.id)

def show_categories(chat_id):
    markup = types.InlineKeyboardMarkup()
    for cat in data_storage.keys():
        markup.add(types.InlineKeyboardButton(cat, callback_data=f"cat_{cat}"))
    markup.add(types.InlineKeyboardButton("В меню", callback_data="to_main"))
    bot.send_message(chat_id, "Выберите тематику раунда:", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "В меню")
def manual_back(message):
    main_menu(message.chat.id)

@bot.callback_query_handler(func=lambda call: call.data.startswith("cat_"))
def start_game(call):
    category_name = call.data.replace("cat_", "")
    chat_id = call.message.chat.id
    word = random.choice(list(data_storage[category_name].keys()))
    info = data_storage[category_name][word]
    
    game_data[chat_id].update({
        "mafia_index": random.randint(1, game_data[chat_id]["count"]),
        "word": word, "desc": info["desc"], "img": info.get("img"), "category": category_name
    })
    try: bot.delete_message(chat_id, call.message.message_id)
    except: pass
    send_turn(chat_id)

def send_turn(chat_id):
    data = game_data[chat_id]
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("УЗНАТЬ РОЛЬ", callback_data="reveal_role"))
    bot.send_message(chat_id, f"Игрок номер {data['current']}, ваш ход", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "reveal_role")
def reveal(call):
    chat_id = call.message.chat.id
    data = game_data[chat_id]
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("СКРЫТЬ", callback_data="next_player"))
    
    if data["current"] == data["mafia_index"]:
        bot.send_message(chat_id, "ВЫ ШПИОН\n\nВаша задача — не спались", reply_markup=markup)
    else:
        text = f"ВЫ МИРНЫЙ\n\nТема: {data['category']}\nОбъект: {data['word']}\nИнфо: {data['desc']}"
        if data.get("img"):
            try: bot.send_photo(chat_id, data["img"], caption=text, reply_markup=markup)
            except: bot.send_message(chat_id, text, reply_markup=markup)
        else:
            bot.send_message(chat_id, text, reply_markup=markup)
    
    try: bot.delete_message(chat_id, call.message.message_id)
    except: pass

@bot.callback_query_handler(func=lambda call: call.data == "next_player")
def next_p(call):
    chat_id = call.message.chat.id
    try: bot.
delete_message(chat_id, call.message.message_id)
    except: pass
    if game_data[chat_id]["current"] < game_data[chat_id]["count"]:
        game_data[chat_id]["current"] += 1
        send_turn(chat_id)
    else:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Играть снова", callback_data="repeat_game"))
        markup.add(types.InlineKeyboardButton("Выбрать другую тему", callback_data="new_category"))
        markup.add(types.InlineKeyboardButton("В меню", callback_data="to_main"))
        bot.send_message(chat_id, "Все роли розданы. Начинайте обсуждение", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "repeat_game")
def repeat(call):
    try: bot.delete_message(call.message.chat.id, call.message.message_id)
    except: pass
    spy_start(call)

@bot.callback_query_handler(func=lambda call: call.data == "new_category")
def new_cat(call):
    try: bot.delete_message(call.message.chat.id, call.message.message_id)
    except: pass
    show_categories(call.message.chat.id)

if name == "__main__":
    bot.infinity_polling()
