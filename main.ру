import telebot
from telebot import types
import random

# --- НАСТРОЙКИ ---
TOKEN = '8352938832:AAGooh41WdnQgmcqNxBzYSnC1QvqMpeCqBg'
CHANNEL_ID = '@swag40444' 

bot = telebot.TeleBot(TOKEN)

# --- БАЗА ДАННЫХ ---
data_storage = {
    "РЕПЕРЫ": {
        "Бунтовский": "Исполнитель", "Платина": "Роберт Плаудис", "OG Buda": "Григорий Ляхов", 
        "Mayot": "Артем Никитин", "Toxi$": "Андрей Смелянский", "Big Baby Tape": "Егор Ракитин", 
        "Morgenshtern": "Алишер", "Scally Milano": "Даниил Слонов", "163ONMYNECK": "Роман Щуров", 
        "Bushido Zho": "Жоас Мапуа", "Soda Luv": "Владислав Т.", "Obladaet": "Назар Вотяков", 
        "Kizaru": "Олег Н.", "Friendly Thug 52": "Александр С.", "Heronwater": "Арсений Г.", "Yanix": "Янис Б."
    },
    "МАШИНЫ": {
        "BMW M5": "Немецкий седан", "Mercedes G63": "Внедорожник", "Lada Priora": "Отечественный авто", 
        "Toyota Camry": "Японский седан", "Tesla Model S": "Электрокар", "Audi RS6": "Универсал", 
        "Porsche 911": "Спорткар", "Nissan GTR": "Японский спорткар", "Rolls-Royce": "Люкс", "Lamborghini": "Суперкар"
    },
    "ИГРЫ": {
        "Minecraft": "Песочница", "CS 2": "Шутер", "Dota 2": "MOBA", "GTA 5": "Экшен", 
        "Brawl Stars": "Мобильная игра", "Roblox": "Платформа", "Fortnite": "Батл рояль", 
        "PUBG": "Выживание", "FIFA": "Футбол", "Among Us": "Детектив"
    },
    "ЕДА": {
        "Шаурма": "Мясо в лаваше", "Пицца": "Тесто с сыром", "Борщ": "Суп", 
        "Суши": "Рис с рыбой", "Бургер": "Булка с котлетой", "Пельмени": "Мясо в тесте", 
        "Хинкали": "Грузинское блюдо", "Паста": "Макароны", "Стейк": "Мясо", "Плов": "Рис с мясом"
    }
}

game_data = {}

def check_subscribe(user_id):
    try:
        status = bot.get_chat_member(CHANNEL_ID, user_id).status
        return status in ['member', 'administrator', 'creator']
    except: return False

def main_menu(chat_id):
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("Режим Шпион", callback_data="mode_spy"))
    markup.add(types.InlineKeyboardButton("Режим Рандомайзер", callback_data="mode_rand"))
    bot.send_message(chat_id, "Выберите режим игры или функцию:", reply_markup=markup)

@bot.message_handler(commands=['start'])
def start(message):
    if check_subscribe(message.from_user.id):
        main_menu(message.chat.id)
    else:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Подписаться", url="https://t.me/swag40444"))
        markup.add(types.InlineKeyboardButton("Я подписался", callback_data="check_sub"))
        bot.send_message(message.chat.id, "Для использования бота подпишитесь на канал.", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "check_sub")
def sub_check(call):
    if check_subscribe(call.from_user.id):
        try: bot.delete_message(call.message.chat.id, call.message.message_id)
        except: pass
        main_menu(call.message.chat.id)
    else:
        bot.answer_callback_query(call.id, "Подписка не найдена", show_alert=True)

@bot.callback_query_handler(func=lambda call: call.data == "to_main")
def back_to_main(call):
    try: bot.delete_message(call.message.chat.id, call.message.message_id)
    except: pass
    main_menu(call.message.chat.id)

# --- РАНДОМАЙЗЕР ---
@bot.callback_query_handler(func=lambda call: call.data == "mode_rand")
def rand_start(call):
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("В меню", callback_data="to_main"))
    bot.edit_message_text("Введите диапазон через пробел (например: 1 100):", call.message.chat.id, call.message.message_id, reply_markup=markup)
    bot.register_next_step_handler(call.message, process_random)

def process_random(message):
    try:
        nums = [int(i) for i in message.text.split()]
        res = random.randint(min(nums), max(nums))
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Еще раз", callback_data="mode_rand"))
        markup.add(types.InlineKeyboardButton("В меню", callback_data="to_main"))
bot.send_message(message.chat.id, f"Результат: {res}", reply_markup=markup)
    except:
        bot.send_message(message.chat.id, "Ошибка. Введите два числа через пробел.")
        main_menu(message.chat.id)

# --- ШПИОН ---
@bot.callback_query_handler(func=lambda call: call.data == "mode_spy")
def spy_start(call):
    markup = types.ReplyKeyboardMarkup(resize_keyboard=True, one_time_keyboard=True)
    markup.add("3", "4", "5", "6", "В меню")
    bot.send_message(call.message.chat.id, "Сколько человек играет?", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text in ["3", "4", "5", "6"])
def select_category(message):
    game_data[message.chat.id] = {"count": int(message.text), "current": 1}
    show_categories(message.chat.id)

def show_categories(chat_id):
    markup = types.InlineKeyboardMarkup()
    for cat in data_storage.keys():
        markup.add(types.InlineKeyboardButton(cat, callback_data=f"cat_{cat}"))
    markup.add(types.InlineKeyboardButton("В меню", callback_data="to_main"))
    bot.send_message(chat_id, "Выберите тематику раунда:", reply_markup=markup)

@bot.message_handler(func=lambda m: m.text == "В меню")
def manual_back(message):
    main_menu(message.chat.id)

@bot.callback_query_handler(func=lambda call: call.data.startswith("cat_"))
def start_game(call):
    category_name = call.data.replace("cat_", "")
    chat_id = call.message.chat.id
    word = random.choice(list(data_storage[category_name].keys()))
    desc = data_storage[category_name][word]
    
    game_data[chat_id].update({
        "mafia_index": random.randint(1, game_data[chat_id]["count"]),
        "word": word, "desc": desc, "category": category_name
    })
    try: bot.delete_message(chat_id, call.message.message_id)
    except: pass
    send_turn(chat_id)

def send_turn(chat_id):
    data = game_data[chat_id]
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("УЗНАТЬ РОЛЬ", callback_data="reveal_role"))
    bot.send_message(chat_id, f"Игрок номер {data['current']}, ваш ход", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "reveal_role")
def reveal(call):
    chat_id = call.message.chat.id
    data = game_data[chat_id]
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton("СКРЫТЬ", callback_data="next_player"))
    
    if data["current"] == data["mafia_index"]:
        text = "ВЫ ШПИОН\n\nВаша задача — не спались"
    else:
        text = f"ВЫ МИРНЫЙ\n\nТема: {data['category']}\nОбъект: {data['word']}\nИнфо: {data['desc']}"
    
    bot.edit_message_text(text, chat_id, call.message.message_id, reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "next_player")
def next_p(call):
    chat_id = call.message.chat.id
    try: bot.delete_message(chat_id, call.message.message_id)
    except: pass
    if game_data[chat_id]["current"] < game_data[chat_id]["count"]:
        game_data[chat_id]["current"] += 1
        send_turn(chat_id)
    else:
        markup = types.InlineKeyboardMarkup()
        markup.add(types.InlineKeyboardButton("Играть снова", callback_data="repeat_game"))
        markup.add(types.InlineKeyboardButton("Выбрать другую тему", callback_data="new_category"))
        markup.add(types.InlineKeyboardButton("В меню", callback_data="to_main"))
        bot.send_message(chat_id, "Все роли розданы. Начинайте обсуждение", reply_markup=markup)

@bot.callback_query_handler(func=lambda call: call.data == "repeat_game")
def repeat(call):
    try: bot.delete_message(call.message.chat.id, call.message.message_id)
    except: pass
    spy_start(call)

@bot.callback_query_handler(func=lambda call: call.data == "new_category")
def new_cat(call):
    try: bot.delete_message(call.message.chat.id, call.message.message_id)
    except: pass
    show_categories(call.message.chat.id)

if name == "__main__":
    bot.infinity_polling()
